---
title: ".Net8 ã§è¿½åŠ ã•ã‚ŒãŸã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å¼ã§åˆæœŸåŒ–ã§ãã‚‹ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã‚¯ãƒ©ã‚¹ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…ã™ã‚‹"
emoji: "ğŸ“¦"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["csharp", "dotnet", "ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³"]
published: true
---

C# ã§é…åˆ—ã‚’åˆæœŸåŒ–ã™ã‚‹ã¨ãã€ã©ã†ã‚„ã£ã¦ã„ã¾ã™ã‹?  
C# 12.0 (.NET 8.0) ã‹ã‚‰ã¯ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å¼ãŒåˆ©ç”¨å¯èƒ½ã«ãªã‚Šã¾ã—ãŸã€‚  
ä¸‹è¨˜ã®ã‚³ãƒ¼ãƒ‰ä¾‹ã‹ã‚‰ã‚ã‹ã‚‹ã‚ˆã†ã«ã€é…åˆ—ã®ç¨®é¡ã‚’å•ã‚ãšåŒã˜æ§˜ã«ã€ãã—ã¦ç›´æ„Ÿçš„ã«åˆæœŸåŒ–ã§ãã¾ã™ã€‚

```csharp
int[] array = [1, 2, 3, 4, 5];
List<int> list = [1, 2, 3, 4, 5];
ImmutableArray<int> immutableArray = [1, 2, 3, 4, 5];
```

ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å¼ã®ã‚ˆã‚Šè©³ã—ã„èª¬æ˜ã‚„ãƒ¡ãƒªãƒƒãƒˆãªã©ã¯ã“ã¡ã‚‰ãŒã‚ã‹ã‚Šã‚„ã™ã„ã§ã™ã€‚

https://ufcpp.net/study/csharp/cheatsheet/ap_ver12/

ä»Šå›ã¯è‡ªä½œã®ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã‚¯ãƒ©ã‚¹ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§ã‚‚ã€ã“ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å¼ã‚’åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚  

## TL;DR

- ã‚¯ãƒ©ã‚¹ã« `CollectionBuilder(typeof(MyCollection), nameof(Create))` å±æ€§ã‚’ä»˜ä¸
- static ãª `MyCollection Create(ReadOnlySpan)` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè£…

## è£œè¶³: ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã‚¯ãƒ©ã‚¹ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã¨ã¯

ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã‚¯ãƒ©ã‚¹ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã¨ã¯ã€å¤§é›‘æŠŠã«èª¬æ˜ã™ã‚Œã°ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒ©ãƒƒãƒ—ã—ãŸã‚¯ãƒ©ã‚¹ã®ã“ã¨ã§ã™ã€‚  
ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†…ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«é–¢ã™ã‚‹æ“ä½œã‚’ãã®ã‚¯ãƒ©ã‚¹ã«é›†ç´„ã—ã€ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®æŒ¯ã‚‹èˆã„ã‚’ã‚«ãƒ—ã‚»ãƒ«åŒ–ï½¥åˆ¶é™ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

è©³ã—ã„ä½¿ã„æ–¹ã‚„ãƒ¡ãƒªãƒƒãƒˆã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã®æ›¸ç±ãŒã‚ã‹ã‚Šã‚„ã™ã„ã§ã™ã€‚

https://gihyo.jp/book/2022/978-4-297-12783-1

## ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã‚¯ãƒ©ã‚¹ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®å®Ÿè£…

ã¾ãšã¯ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å¼ãªã—ã€ã¤ã¾ã‚Š C# 12.0 ã‚ˆã‚Šå‰ã®ã‚„ã‚Šæ–¹ã§ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã‚¯ãƒ©ã‚¹ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

```csharp
public class ImmutableIntCollection : IEnumerable<int>
{
    private readonly ImmutableArray<int> _items;

    public ImmutableIntCollection(IEnumerable<int> items)
    {
        _items = items.ToImmutableArray();
    }

    public int Count => _items.Length;

    public bool Contains(int item) => _items.Contains(item);

    public int Sum() => _items.Sum();

    public double Average() => _items.Average();

    public ImmutableIntCollection Add(int item)
    {
        return new ImmutableIntCollection(_items.Add(item));
    }

    public ImmutableIntCollection Remove(int item)
    {
        return new ImmutableIntCollection(_items.Remove(item));
    }

    public IEnumerator<int> GetEnumerator() => _items.GetEnumerator();

    IEnumerator IEnumerable.GetEnumerator() => GetEnumerator();

    public override string ToString() => $"[{string.Join(", ", _items)}]";
}
```

ã“ã®ä¾‹ã§ã¯ã€IEnumerable<int> ã‚’å®Ÿè£…ã—ãŸä¸å¤‰ãªã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ `ImmutableIntCollection` ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã—ã¾ã—ãŸã€‚  
ã“ã®ã‚ˆã†ãªã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã—ãŸå ´åˆã€åˆ©ç”¨æ–¹æ³•ã¯ä¸‹è¨˜ã®ã‚ˆã†ã«ãªã‚‹ã§ã—ã‚‡ã†ã€‚

```csharp
var collection = new ImmutableIntCollection(new[] { 1, 2, 3, 4, 5 });
Console.WriteLine(collection); // å‡ºåŠ›: [1, 2, 3, 4, 5]
Console.WriteLine($"Sum: {collection.Sum()}"); // å‡ºåŠ›: Sum: 15
Console.WriteLine($"Average: {collection.Average()}"); // å‡ºåŠ›: Average: 3

var newCollection = collection.Add(6);
Console.WriteLine(collection); // å‡ºåŠ›: [1, 2, 3, 4, 5]ï¼ˆå…ƒã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã¯å¤‰æ›´ã•ã‚Œãªã„ï¼‰
Console.WriteLine(newCollection); // å‡ºåŠ›: [1, 2, 3, 4, 5, 6]
```

ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®æ“ä½œè‡ªä½“ã¯ã‚·ãƒ³ãƒ—ãƒ«ã§ã‚ã‹ã‚Šã‚„ã™ã„ã§ã™ãŒã€é…åˆ—ã®åˆæœŸåŒ–ã‚’ã™ã‚‹ãŸã‚ã«å…ƒãƒ‡ãƒ¼ã‚¿ã®é…åˆ—ã‚’ä½œã‚‹ã¨ã„ã†å‡¦ç†ãŒå¿…è¦ã§ã‚„ã‚„å†—é•·ã§ã™ã€‚

## ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å¼ã‚’åˆ©ç”¨ã—ãŸãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã‚¯ãƒ©ã‚¹ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®å®Ÿè£…

ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å¼ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã‚¯ãƒ©ã‚¹ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚ˆã‚Šç°¡æ½”ã«åˆ©ç”¨ã§ãã¾ã™ã€‚  
ä¸‹è¨˜ã®ã‚³ãƒ¼ãƒ‰ä¾‹ã§ã¯ã€`ImmutableIntCollection` ã‚¯ãƒ©ã‚¹ã‚’æ‹¡å¼µã—ã€ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å¼ã‚’åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

```diff csharp
+ [CollectionBuilder(typeof(ImmutableIntCollection), nameof(Create))]
public class ImmutableIntCollection : IEnumerable<int>
{
    private readonly ImmutableArray<int> _items;

    public ImmutableIntCollection(IEnumerable<int> items)
    {
        _items = items.ToImmutableArray();
    }

+     public static ImmutableIntCollection Create(ReadOnlySpan<int> items)
+     {
+         return new ImmutableIntCollection(items.ToArray());
+     }

    // æ®‹ã‚Šã¯åŒã˜ãªã®ã§çœç•¥
}
```

ä¸»ãªå¤‰æ›´ã¯ä»¥ä¸‹ã®2ã¤ã§ã™ã€‚

1. `CollectionBuilder` å±æ€§ã®è¿½åŠ 

    ```csharp
    [CollectionBuilder(typeof(ImmutableIntCollection), nameof(Create))]
    ```

    ã“ã‚Œã«ã‚ˆã‚Šã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãŒã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å¼ã‚’è§£é‡ˆã™ã‚‹éš›ã«ã€`ImmutableIntCollection.Create` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã™ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

2. static ãª `Create` ãƒ¡ã‚½ãƒƒãƒ‰ã®è¿½åŠ 

    ```csharp
    public static ImmutableIntCollection Create(ReadOnlySpan<int> items)
    {
        return new ImmutableIntCollection(items.ToArray());
    }
    ```

    ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å¼ã§æ¸¡ã•ã‚Œã‚‹ `ReadOnlySpan<int>` ã‚’ `ImmutableIntCollection` ã«å¤‰æ›ã—ã¦è¿”å´ã™ã‚‹ãŸã‚ã®ãƒ¡ã‚½ãƒƒãƒ‰ã§ã™ã€‚

ã“ã‚Œã‚‰ã®å¤‰æ›´ã«ã‚ˆã‚Šã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å¼ã‚’ä½¿ç”¨ã—ã¦ImmutableIntCollectionã‚’åˆæœŸåŒ–ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚  
ä¸‹è¨˜ã®åˆ©ç”¨ä¾‹ã‚’è¦‹ã¦ã„ãŸã ã‘ã‚Œã°ã€ä»Šã¾ã§ã®åˆæœŸåŒ–å‡¦ç†ã¨æ¯”ã¹ã¦ã€ãƒ¼ãƒ‰ãŒç°¡æ½”ã«ãªã£ãŸã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

```csharp
ImmutableIntCollection collection = [1, 2, 3, 4, 5];
Console.WriteLine(collection); // å‡ºåŠ›: [1, 2, 3, 4, 5]
Console.WriteLine($"Sum: {collection.Sum()}"); // å‡ºåŠ›: Sum: 15
Console.WriteLine($"Average: {collection.Average()}"); // å‡ºåŠ›: Average: 3

var newCollection = collection.Add(6);
Console.WriteLine(collection); // å‡ºåŠ›: [1, 2, 3, 4, 5]ï¼ˆå…ƒã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã¯å¤‰æ›´ã•ã‚Œãªã„ï¼‰
Console.WriteLine(newCollection); // å‡ºåŠ›: [1, 2, 3, 4, 5, 6]
```

## ã¾ã¨ã‚

ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å¼ã®åˆ©ç”¨ã¯ã‚³ãƒ¼ãƒ‰ã®æ›¸ãã‚„ã™ã•ã¨å¯èª­æ€§ã‚’å‘ä¸Šã•ã›ã€é–‹ç™ºåŠ¹ç‡ã‚‚å‘ä¸Šã—ã¾ã™ã€‚  
ã¾ãŸå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’èª­ã¿è§£ãã¨ã€ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å¼ã¯ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®æœ€é©åŒ–ã‚‚å›³ã£ã¦ã„ã‚‹ã¨ã®ã“ã¨ã§ã™ã€‚

> ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã¯ã€ã‚¹ã‚¿ãƒ†ã‚£ãƒƒã‚¯åˆ†æã‚’ä½¿ç”¨ã—ã¦ã€ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å¼ã§å®£è¨€ã•ã‚ŒãŸã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹æœ€ã‚‚ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®é«˜ã„æ–¹æ³•ã‚’åˆ¤æ–­ã—ã¾ã™ã€‚
> å¼•ç”¨å…ƒ: https://learn.microsoft.com/ja-jp/dotnet/csharp/language-reference/operators/collection-expressions

ã“ã‚Œã‹ã‚‰ã® C# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã€ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å¼ã‚’ç©æ¥µçš„ã«åˆ©ç”¨ã—ã¦ã„ãã“ã¨ãŒæœ›ã¾ã—ã„ã§ã—ã‚‡ã†ã€‚  
ä»Šå›ç´¹ä»‹ã—ãŸã‚ˆã†ã«ã€è‡ªä½œã®ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã‚¯ãƒ©ã‚¹ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§ã‚‚ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å¼ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚  
ãœã²æ´»ç”¨ã—ã¦ã¿ã¦ãã ã•ã„ã€‚
